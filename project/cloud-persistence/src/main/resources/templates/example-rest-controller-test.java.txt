package ${package};

import ${exampleDTO};
import ${exampleService};
import org.junit.After;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.web.client.TestRestTemplate;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpMethod;
import org.springframework.http.ResponseEntity;
import org.springframework.test.context.TestPropertySource;
import org.springframework.test.context.junit4.SpringRunner;

import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import static org.assertj.core.api.Assertions.assertThat;

/**
 * @author The Great Tool
 * @since ${created}
 */
@TestPropertySource(locations = "classpath:test-application.properties")
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@RunWith(SpringRunner.class)
public class ExampleControllerRestTest {

    @Autowired
    private TestRestTemplate restTemplate;

    @Autowired
    private ExampleService<ExampleDTO, Long> exampleService;

    @Value("${rest.url}")
    private String restUrl;

    @Value("${rest.content.type}")
    private String contentType;

    @Value("${rest.exception.message}")
    private String exceptionMessage;

    private ExampleDTO exampleDTO;

    private List<ExampleDTO> exampleDTOs;

    private Map<String, Object> patches;

    @Before
    public void setUp() {
        exampleDTO = new ExampleDTO();
        exampleDTO.setData("some DTO");

        ExampleDTO anotherExampleDTO = new ExampleDTO();
        anotherExampleDTO.setData("another some DTO");

        exampleDTOs = Arrays.asList(exampleDTO, anotherExampleDTO);

        patches = new HashMap<>();

        clearDataBase();
    }

    @Test
    public void create() {
        createDTO(exampleDTO);
    }

    @Test
    public void read() {
        ResponseEntity<ExampleDTO> response = createDTO(exampleDTO);

        readDTO(response.getBody().getId());
    }

    @Test
    public void readAll() {
        checkNoExampleDTOs();

        createTestExampleDTOs(exampleDTOs);

        readAllExampleDTOs(exampleDTOs.size());
    }

    @Test
    public void update() {
        ResponseEntity<ExampleDTO> response = createDTO(exampleDTO);

        ExampleDTO updatedDTO = response.getBody();
        updatedDTO.setData("updated DTO");

        updateDTO(updatedDTO);

        updateDTOWithIllegalId(null);

        updatedDTO.setId(null);
        updateDTOWithIllegalId(updatedDTO);

        updatedDTO.setId(-1L);
        updateDTOWithIllegalId(updatedDTO);
    }

    @Test
    public void patch() {
        ResponseEntity<ExampleDTO> response = createDTO(exampleDTO);

        Long dtoId = response.getBody().getId();
        patches.put("id", response.getBody().getId());
        patches.put("data", "patched DTO data");

        patchDTO(dtoId, patches);

        patches.put("id", 0L);
        patchDTOWithIllegalId(patches);

        patches.put("id", null);
        patchDTOWithIllegalId(patches);

        patches.clear();
        patchDTOWithIllegalUpdates(patches);

        patchDTOWithIllegalUpdates(null);
    }

    @Test
    public void delete() {
        ResponseEntity<ExampleDTO> response = createDTO(exampleDTO);

        Long id = response.getBody().getId();

        checkIfExampleDTOExists(id);

        deleteDTO(id);
    }

    @Test
    public void deleteAll() {
        createTestExampleDTOs(exampleDTOs);

        checkIfExampleDTOsExist();

        deleteAllDTOs();
    }

    @Test
    public void testExceptionHandler() {
        ResponseEntity<String> response = restTemplate.getForEntity(getUrl(0), String.class);
        checkExceptionResponse(response);

        exampleDTO.setData(null);
        response = restTemplate.postForEntity(restUrl, exampleDTO, String.class);
        checkExceptionResponse(response);
    }

    @After
    public void tearDown() {
        clearDataBase();
    }

    private ResponseEntity<ExampleDTO> createDTO(ExampleDTO exampleDTO) {
        ResponseEntity<ExampleDTO> response = restTemplate.postForEntity(restUrl, exampleDTO, ExampleDTO.class);
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.CREATED);
        assertThat(response.getHeaders().getLocation()).isNotNull();
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getHeaders().getContentType()).isEqualTo(MediaType.valueOf(contentType));
        assertThat(response.getHeaders().getLocation().getPath()).isEqualTo(getUrl(response.getBody().getId()));
        assertThat(response.getBody().getId()).isNotNull();
        assertThat(response.getBody().getData()).isEqualTo(exampleDTO.getData());
        return response;
    }

    private ResponseEntity<ExampleDTO> readDTO(Long id){
        ResponseEntity<ExampleDTO> response = restTemplate.getForEntity(getUrl(id), ExampleDTO.class);
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().getId()).isNotNull();
        assertThat(response.getBody().getData()).isEqualTo(exampleDTO.getData());
        return response;
    }

    @SuppressWarnings (value="unchecked")
    private ResponseEntity<List<ExampleDTO>> readAllExampleDTOs(int dtoCount) {
        ResponseEntity<?> response = restTemplate.getForEntity(restUrl, List.class);
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody()).isNotNull();
        assertThat(((List<?>)response.getBody()).size() == dtoCount).isTrue();
        return (ResponseEntity<List<ExampleDTO>>)response;
    }

    private ResponseEntity<ExampleDTO> updateDTO(ExampleDTO updatedDTO) {
        restTemplate.put(restUrl, updatedDTO);
        ResponseEntity<ExampleDTO> response = restTemplate.getForEntity(getUrl(String.valueOf(updatedDTO.getId())), ExampleDTO.class);
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().getId()).isEqualTo(updatedDTO.getId());
        assertThat(response.getBody().getData()).isEqualTo(updatedDTO.getData());
        return response;
    }

    private ResponseEntity<String> updateDTOWithIllegalId(ExampleDTO updatedDTO) {
        HttpEntity<ExampleDTO> httpEntity = new HttpEntity<>(updatedDTO);
        ResponseEntity<String> response = restTemplate.exchange(restUrl, HttpMethod.PUT, httpEntity, String.class);
        assertThat(response.getStatusCode()).isEqualTo(updatedDTO != null ? HttpStatus.BAD_REQUEST : HttpStatus.CONFLICT);
        assertThat(response.getBody()).isNotNull();
        if (updatedDTO == null) {
            assertThat(response.getBody().contains("Required request body is missing")).isTrue();
        } else {
            assertThat(response.getBody()).isEqualTo("Unable to update ExampleDTO due to illegal id");
        }

        return response;
    }

    private ResponseEntity<ExampleDTO> patchDTO(Long id, Map<String, Object> patches) {
        ResponseEntity<ExampleDTO> response = restTemplate.postForEntity(String.format("%s?_method=patch", restUrl), patches, ExampleDTO.class);
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().getId()).isEqualTo(id);
        assertThat(response.getBody().getData()).isEqualTo(patches.get("data"));
        return response;
    }

    private void patchDTOWithIllegalId(Map<String, Object> patches) {
        ResponseEntity<String> response = restTemplate.postForEntity(String.format("%s?_method=patch", restUrl), patches, String.class);
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.BAD_REQUEST);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody()).isEqualTo("Unable to patch ExampleDTO due to illegal id");
    }

    private void patchDTOWithIllegalUpdates(Map<String, Object> patches) {
            ResponseEntity<String> response = restTemplate.postForEntity(String.format("%s?_method=patch", restUrl), patches, String.class);
            assertThat(response.getStatusCode()).isEqualTo(patches != null ? HttpStatus.BAD_REQUEST : HttpStatus.CONFLICT);
            assertThat(response.getBody()).isNotNull();
            assertThat(response.getBody()).isEqualTo(patches != null ?
    		"Unable to patch ExampleDTO due to bad request" :
    		"Content type 'application/x-www-form-urlencoded;charset=UTF-8' not supported");
    }

    private void deleteDTO(Long id) {
        restTemplate.delete(getUrl(String.valueOf(id)));
        checkNoExampleDTO(id);
    }

    private void deleteAllDTOs() {
        restTemplate.delete(restUrl);
        checkNoExampleDTOs();
    }

    private void checkNoExampleDTOs() {
        ResponseEntity<String> response = restTemplate.getForEntity(restUrl, String.class);
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.NO_CONTENT);
        assertThat(response.getBody()).isNull();
    }

    private void checkNoExampleDTO(Long id) {
        ResponseEntity<ExampleDTO> response = restTemplate.getForEntity(getUrl(String.valueOf(id)), ExampleDTO.class);
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.NO_CONTENT);
        assertThat(response.getBody()).isNull();
    }

    private void checkIfExampleDTOExists(Long id) {
        ResponseEntity<ExampleDTO> response = restTemplate.getForEntity(getUrl(String.valueOf(id)), ExampleDTO.class);
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody()).isNotNull();
    }

    private void checkIfExampleDTOsExist() {
        ResponseEntity<?> response = restTemplate.getForEntity(restUrl, List.class);
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody()).isNotNull();
        assertThat(((List<?>)response.getBody()).size() > 0).isNotNull();
    }

    private void checkExceptionResponse(ResponseEntity<String> response) {
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.CONFLICT);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody()).isEqualTo(exceptionMessage);
    }

    private void createTestExampleDTOs(List<ExampleDTO> exampleDTOs) {
        for (ExampleDTO exampleDTO : exampleDTOs) {
            createDTO(exampleDTO);
        }
    }

    private String getUrl(Object pathVar){
        return String.format("%s/%s", restUrl, pathVar);
    }

    private void clearDataBase() {
        exampleService.deleteAll();
    }
}
